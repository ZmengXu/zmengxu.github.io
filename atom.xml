<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Zmeng Blogs</title>
  
  <subtitle>记一些IoT和OpenFOAM的事儿</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://zmengxu.github.io/"/>
  <updated>2020-11-01T21:20:52.077Z</updated>
  <id>http://zmengxu.github.io/</id>
  
  <author>
    <name>Zmeng</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>How does the dynamic library loading work in OpenFOAM</title>
    <link href="http://zmengxu.github.io/2020/10/DynamicLibraries/"/>
    <id>http://zmengxu.github.io/2020/10/DynamicLibraries/</id>
    <published>2020-10-31T22:03:54.000Z</published>
    <updated>2020-11-01T21:20:52.077Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>In OpenFOAM, the solvers and numerical models are separated. Most of the numerical models are located in the <code>$FOAM_SRC</code> path, and being compiled to a dynamic library “.so” binary file, which can be loaded either by linking it during the solver compiling process or loading it by specify the “.so” file in the case controlDict.  For example, we develop a new combustion model, named <code>PaSR</code>, and compile it to a “libPaSR.so”. When we run a case, we just need to add a line <code>libs   (&quot;libPaSR.so&quot;);</code> in <code>controlDict</code>. Then, we can see and use this model in the <code>reactingFoam</code> solver.</p></blockquote><hr><blockquote><p>How does the “libPaSR.so” file is loaded, and why the solver knows that a new model “PaSR” is available? This blog will explain it.</p></blockquote><h1 id="dynamic-library-loading-in-C"><a href="#dynamic-library-loading-in-C" class="headerlink" title="dynamic library loading in C++"></a>dynamic library loading in C++</h1><p>Before digging into OpenFOAM, let’s see how does the dynamic library is loaded in C++. There are three famous function named <code>dlopen</code>, <code>dlsym</code> and <code>dlclose</code>, which are used to open, find function address and close library, in your operating system.</p><h2 id="library-loading-searching-and-closing"><a href="#library-loading-searching-and-closing" class="headerlink" title="library loading searching and closing"></a>library loading searching and closing</h2><p>I wrote a short code to demonstrate how does it work, see <a href="https://github.com/ZmengXu/dynamicLibloading/tree/master/ch01" target="_blank" rel="noopener">https://github.com/ZmengXu/dynamicLibloading/tree/master/ch01</a></p><p>First, we define two models WSR and PaSR (which are two simple combustion model) in two <code>.C</code> files. Each file has only one simple function, named <code>get_library_name</code>. Compiling these two <code>.C</code> files to two libraries, <code>libWSR.so</code> and <code>libPaSR.so</code>.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In WSR.C</span></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">get_library_name</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"This is WSR"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In PaSR.C</span></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">get_library_name</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"This is PaSR"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Second, we write a solver named <code>solverFoam</code> to call <code>get_library_name</code> function in <code>libWSR.so</code> and <code>libPaSR.so</code>.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"word.H"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"IOstreams.H"</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Foam;</span><br><span class="line"></span><br><span class="line"><span class="comment">// define a function pointer type</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">char</span>* (*funcType)(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc&lt;<span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Info &lt;&lt; <span class="string">"usage: &lt;library&gt;\n"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* librarypath = argv[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// RTLD_LAZY means "there may be symbols that can't be resolved;</span></span><br><span class="line">    <span class="comment">// don't try to resolve them until they're used." </span></span><br><span class="line">    <span class="keyword">auto</span> libhandle = dlopen(librarypath, RTLD_LAZY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(libhandle != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Info &lt;&lt; librarypath &lt;&lt; <span class="string">" is found."</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> voidPtr = dlsym(libhandle, <span class="string">"_Z16get_library_namev"</span>);</span><br><span class="line"></span><br><span class="line">        funcType funcPtr = (funcType)voidPtr;</span><br><span class="line"></span><br><span class="line">        Info &lt;&lt; funcPtr() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">        dlclose(libhandle);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Info &lt;&lt; librarypath &lt;&lt; <span class="string">" is not found."</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Info &lt;&lt; <span class="string">"End."</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In this code, we get the librarypath from the solver argument, and try to find the dynamic library, load the library to computer memory and get a handle libhandle using dlopen. We use dlsym to find the function <code>_Z16get_library_namev</code> in this library and call this function to print its information.</p><p>you can use Allrun in <a href="https://github.com/ZmengXu/dynamicLibloading/blob/master/Allrun" target="_blank" rel="noopener">https://github.com/ZmengXu/dynamicLibloading/blob/master/Allrun</a> to compile and run it.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">solverFoam "libWSR.so"</span><br></pre></td></tr></table></figure><p>For example, typing the above commands after compiling the library and solver. It will find the “libWSR.so” in <code>$LD_LIBRARY_PATH</code> and printing the following results.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">libWSR.so is found.</span><br><span class="line">This is WSR</span><br><span class="line">End.</span><br></pre></td></tr></table></figure><h2 id="function-name-decoration"><a href="#function-name-decoration" class="headerlink" title="function name decoration"></a>function name decoration</h2><p>Here, we have two things need to be explained:</p><ul><li><p><code>typedef char* (*funcType)(void);</code> is an alias, define a function pointer type. This function has a return value of <code>char*</code> and a <code>void</code> argument. We call this kind of function as <code>funcType</code>. Now you can understand that Line 32: <code>funcType funcPtr = (funcType)voidPtr;</code> means that we are about to convert <code>voidPtr</code> to a function pointer and assign it to a new <code>funcType</code> type function pointer <code>funcPtr</code>. Thus, it can be used as <code>funcPtr()</code> in Line 34.</p></li><li><p>You must be curious that the function name we defined in <code>PaSR.C</code> is “get_library_name”, but why we are looking for the function name “_Z16get_library_namev”. This is due to the <a href="https://en.wikipedia.org/wiki/Name_mangling" target="_blank" rel="noopener">name mangling</a> (also called name decoration) in C++ compiler. We can use <code>objdump -tT $FOAM_USER_LIBBIN/libPaSR.so</code> or <code>nm -D $FOAM_USER_LIBBIN/libPaSR.so</code> to see the function list in the <code>libPaSR.so</code> dynamic libray.</p></li></ul><p>This is an example for <code>nm -D $FOAM_USER_LIBBIN/libPaSR.so</code> result, you can find <code>_Z16get_library_namev</code> in the optput.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">0000000000201040 B __bss_start</span><br><span class="line">                 U __cxa_atexit</span><br><span class="line">                 w __cxa_finalize</span><br><span class="line">0000000000201040 D _edata</span><br><span class="line">0000000000201048 B _end</span><br><span class="line">0000000000000924 T _fini</span><br><span class="line">                 w __gmon_start__</span><br><span class="line">0000000000000748 T _init</span><br><span class="line">                 w _ITM_deregisterTMCloneTable</span><br><span class="line">                 w _ITM_registerTMCloneTable</span><br><span class="line">                 w _Jv_RegisterClasses</span><br><span class="line">0000000000000900 T _Z16get_library_namev</span><br><span class="line">                 U _ZN4Foam13messageStreamcvRNS_8OSstreamEEv</span><br><span class="line">                 U _ZN4Foam4InfoE</span><br><span class="line">                 U _ZN4FoamlsERNS_7OstreamEPKc</span><br><span class="line">                 U _ZNSt8ios_base4InitC1Ev</span><br><span class="line">                 U _ZNSt8ios_base4InitD1Ev</span><br></pre></td></tr></table></figure><p>The name mangling is a common issue when you want to use Hybrid Programming in OpenFOAM, like “C” and “C++”,  or “fortune” and “C++”. You can use the keyword <code>extern C</code> to avoid the compiler converting function name. For example, we can change WSR.C to:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">get_library_name</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"This is PaSR"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>compile it and use <code>nm -D $FOAM_USER_LIBBIN/libPaSR.so</code> you can get this. The function name is not decorated anymore.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0000000000201020 B __bss_start</span><br><span class="line">                 w __cxa_finalize</span><br><span class="line">0000000000201020 D _edata</span><br><span class="line">0000000000201028 B _end</span><br><span class="line">0000000000000688 T _fini</span><br><span class="line">0000000000000680 T get_library_name</span><br><span class="line">                 w __gmon_start__</span><br><span class="line">0000000000000540 T _init</span><br><span class="line">                 w _ITM_deregisterTMCloneTable</span><br><span class="line">                 w _ITM_registerTMCloneTable</span><br><span class="line">                 w _Jv_RegisterClasses</span><br></pre></td></tr></table></figure><h1 id="dynamic-library-loading-in-OpenFOAM"><a href="#dynamic-library-loading-in-OpenFOAM" class="headerlink" title="dynamic library loading in OpenFOAM"></a>dynamic library loading in OpenFOAM</h1><p>In OpenFOAM, the dynamic library are loaded and unloaded implicitly in the <code>dlLibraryTable</code> class, see <code>$FOAM_SRC/OpenFOAM/db/dynamicLibrary/dlLibraryTable</code>. I created a tutorial code to demonstrate how does it work, see <a href="https://github.com/ZmengXu/dynamicLibloading/tree/master/ch02" target="_blank" rel="noopener">https://github.com/ZmengXu/dynamicLibloading/tree/master/ch02</a></p><h2 id="dlLibraryTable-class"><a href="#dlLibraryTable-class" class="headerlink" title="dlLibraryTable class"></a>dlLibraryTable class</h2><p>In the dlLibraryTable class, it has a constructor using a specific dictionary to look through all the libraries, load the libraries to computer memory and store the library names and pointers to libNames_ and libPtrs_ list. When the dlLibraryTable object is deleted, it will call the deconstructor function to unload these libraries. </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// * * * * * * * * * * * * * * * * Constructors  * * * * * * * * * * * * * * //</span></span><br><span class="line"></span><br><span class="line">Foam::dlLibraryTable::dlLibraryTable</span><br><span class="line">(</span><br><span class="line">    <span class="keyword">const</span> dictionary&amp; dict,</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">word</span>&amp; libsEntry</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">open</span>(dict, libsEntry);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// * * * * * * * * * * * * * * * * Destructor  * * * * * * * * * * * * * * * //</span></span><br><span class="line"></span><br><span class="line">Foam::dlLibraryTable::~dlLibraryTable()</span><br><span class="line">&#123;</span><br><span class="line">    forAllReverse(libPtrs_, i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (libPtrs_[i])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (debug)</span><br><span class="line">            &#123;</span><br><span class="line">                InfoInFunction</span><br><span class="line">                    &lt;&lt; <span class="string">"Closing "</span> &lt;&lt; libNames_[i]</span><br><span class="line">                    &lt;&lt; <span class="string">" with handle "</span> &lt;&lt; <span class="keyword">uintptr_t</span>(libPtrs_[i]) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!dlClose(libPtrs_[i]))</span><br><span class="line">            &#123;</span><br><span class="line">                WarningInFunction&lt;&lt; <span class="string">"Failed closing "</span> &lt;&lt; libNames_[i]</span><br><span class="line">                    &lt;&lt; <span class="string">" with handle "</span> &lt;&lt; <span class="keyword">uintptr_t</span>(libPtrs_[i]) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In the solverFoam, we create a dictionary named controlDict, which will read a dictionary file controlDict, and providing the “libs” as the libsEntry. Then the libraies in the controlDict.libs will be loaded and unloaded automatically. This work is done in the <code>Time</code> class in <code>$FOAM_SRC/OpenFOAM/db/Time</code> and be called from <code>#include &quot;createTime.H&quot;</code> by each CFD solver. This is the reason why the libraries we wrote in the “libs” of controlDict will be loaded automaticlly.</p><h2 id="The-implementation-of-a-short-runTime-selection"><a href="#The-implementation-of-a-short-runTime-selection" class="headerlink" title="The implementation of a short runTime selection"></a>The implementation of a short runTime selection</h2><p>In terms of the libraries, a base class combustionModelBase and a derived class WSR in the combustionModel folder are compiled to libcombustModel.so file.</p><p>In the base class, a static HashTable pointer member WordConstructorTablePtr_ is created. A template class addWordConstructorToTable is defined to operate this pointer. In the addWordConstructorToTable constructor, the static HashTable pointer member WordConstructorTablePtr_ is created and insert a “debug value - typeName” pair into the table. Once the constructor is called, it will print “Try to insert typeName” in the constructor, if the typeName exist in the table, it will print “Duplicate entry  typeName in runtime selection table”.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//In combustionModel.H</span></span><br><span class="line"><span class="keyword">typedef</span> HashTable&lt; label, <span class="keyword">word</span> &gt; WordConstructorTable;</span><br><span class="line"><span class="keyword">static</span> WordConstructorTable* WordConstructorTablePtr_;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt; <span class="class"><span class="keyword">class</span> <span class="title">Type</span> &gt;</span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">addWordConstructorToTable</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    addWordConstructorToTable( <span class="keyword">const</span> <span class="keyword">word</span>&amp; lookup = Type::typeName )</span><br><span class="line">    &#123;</span><br><span class="line">        constructWordConstructorTables();</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Try to insert "</span> &lt;&lt; lookup </span><br><span class="line">        &lt;&lt; <span class="string">" into the WordConstructorTablePtr_"</span></span><br><span class="line">        &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">if</span> (!WordConstructorTablePtr_-&gt;insert(lookup, Type::debug))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cerr</span>&lt;&lt; <span class="string">"Duplicate entry "</span></span><br><span class="line">                &lt;&lt; lookup &lt;&lt; <span class="string">" in runtime selection table "</span></span><br><span class="line">                &lt;&lt; <span class="string">"combustionModelBase"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">            error::safePrintStack(<span class="built_in">std</span>::<span class="built_in">cerr</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ~addWordConstructorToTable()</span><br><span class="line">    &#123;</span><br><span class="line">        destroyWordConstructorTables();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>WSR is inherited from the base class, so it also has the template class addWordConstructorToTable, in the WSR.C, an object addWSRWordConstructorTocombustionModelBaseTable_ is defined, which will call the constructor, and get the above output. We will see when the table is created. This is very important.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//In WSR.C</span></span><br><span class="line">WSR::addWordConstructorToTable&lt; WSR &gt; addWSRWordConstructorTocombustionModelBaseTable_;</span><br></pre></td></tr></table></figure><p>Apart from that, a static function “New” is defined in combustionModelNew.C to search the typeName from this table.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// static Factory Method (selector)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">combustionModelBase::New</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">word</span>&amp; modelName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    Info&lt;&lt; <span class="string">"\nWe are now in combustionModelBase::New fucntion "</span></span><br><span class="line">        &lt;&lt; <span class="string">"\nlooking for the "</span></span><br><span class="line">        &lt;&lt; modelName</span><br><span class="line">        &lt;&lt; <span class="string">" in the WordConstructorTable\n"</span></span><br><span class="line">        &lt;&lt; WordConstructorTablePtr_-&gt;sortedToc()</span><br><span class="line">        &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the class typeName pointer in the RTS Table </span></span><br><span class="line">    <span class="comment">// (HashTable&lt;word, autoPtr&lt;combustionModelBase&gt;(*)(word))</span></span><br><span class="line">    WordConstructorTable::iterator cstrIter =</span><br><span class="line">        WordConstructorTablePtr_-&gt;<span class="built_in">find</span>(modelName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the Factory Method was not found. </span></span><br><span class="line">    <span class="keyword">if</span> (cstrIter == WordConstructorTablePtr_-&gt;<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        FatalErrorIn</span><br><span class="line">        (</span><br><span class="line">            <span class="string">"combustionModelBase::New(const word&amp;)"</span></span><br><span class="line">        )   &lt;&lt; <span class="string">"Unknown combustionModelBase type "</span></span><br><span class="line">            &lt;&lt; modelName &lt;&lt; nl &lt;&lt; nl</span><br><span class="line">            &lt;&lt; <span class="string">"Valid combustionModelBase types are :"</span> &lt;&lt; <span class="built_in">endl</span></span><br><span class="line">            &lt;&lt; WordConstructorTablePtr_-&gt;sortedToc()</span><br><span class="line">            &lt;&lt; <span class="built_in">exit</span>(FatalError);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Info&lt;&lt; <span class="string">"\nWe found the modelName "</span></span><br><span class="line">        &lt;&lt; modelName</span><br><span class="line">        &lt;&lt; <span class="string">"\nThe debug value for it is "</span></span><br><span class="line">        &lt;&lt; (*WordConstructorTablePtr_)[modelName] &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="The-order-of-the-dynamic-libraries-loading"><a href="#The-order-of-the-dynamic-libraries-loading" class="headerlink" title="The order of the dynamic libraries loading"></a>The order of the dynamic libraries loading</h2><p>In the same way, PaSR is defined, the difference is that it is compiled separately to libPaSR.so file. The libcombustModel.so is written in the solverFoam’s Make/options and linked to the solverFoam during the compiling stage. while the libPaSR.so file is loaded when we run the solverFoam. You can use Allrun in <a href="https://github.com/ZmengXu/dynamicLibloading/blob/master/Allrun" target="_blank" rel="noopener">https://github.com/ZmengXu/dynamicLibloading/blob/master/Allrun</a> to compile and run it. Before the libPaSR.so is created, we can not find it in the <code>$LD_LIBRARY_PATH</code>, thus only one model <code>WSR</code> is available in the WordConstructorTable. After libPaSR.so is created, you will see the following outputs.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Try to insert WSR into the WordConstructorTablePtr_</span><br><span class="line"></span><br><span class="line">Entering main()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Loading the libraries</span><br><span class="line"></span><br><span class="line">Try to insert PaSR into the WordConstructorTablePtr_</span><br><span class="line"></span><br><span class="line">After the libraries are loading</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">We are now in combustionModelBase::New fucntion</span><br><span class="line">looking for the PaSR in the WordConstructorTable</span><br><span class="line"></span><br><span class="line">2</span><br><span class="line">(</span><br><span class="line">PaSR</span><br><span class="line">WSR</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">We found the modelName PaSR</span><br><span class="line">The debug value for it is 2</span><br><span class="line"></span><br><span class="line">End</span><br></pre></td></tr></table></figure><p>It is interesting that WSR is inserted into the WordConstructorTablePtr_ before entring main() function, PaSR is inserted into the WordConstructorTablePtr_ after the libPaSR.so is loaded. This is because that libcombust.so is loaded before the main() function, while libPaSR.so is loaded during the run time. Once the dynamic library is loaded, the objects addWSRWordConstructorTocombustionModelBaseTable_ and addPaSRWordConstructorTocombustionModelBaseTable_ are constructed automatically in the computer memory as global variables. If we load one library twice, the insert function will reject the inserting. This is why we see the Duplicate entry before the OpenFOAM output header.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;In OpenFOAM, the solvers and numerical models are separated. Most of the numerical models are located in the &lt;code&gt;$FOAM_SRC
      
    
    </summary>
    
      <category term="software" scheme="http://zmengxu.github.io/categories/software/"/>
    
    
      <category term="code analysis" scheme="http://zmengxu.github.io/tags/code-analysis/"/>
    
      <category term="OpenFOAM" scheme="http://zmengxu.github.io/tags/OpenFOAM/"/>
    
  </entry>
  
  <entry>
    <title>在Linux和Windows下安装OpenFOAM-8和OpenFOAMv2006</title>
    <link href="http://zmengxu.github.io/2020/08/OpenFOAMInstall/"/>
    <id>http://zmengxu.github.io/2020/08/OpenFOAMInstall/</id>
    <published>2020-08-16T20:10:00.000Z</published>
    <updated>2020-11-01T21:20:52.077Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>OpenFOAM最近发布了最新的两个版本OpenFOAM-8和OpenFOAMv2006, 这篇博客简单介绍一下这两个版本的区别，然后讲一下如何在Ubuntu和Windows系统下安装这两个版本的OpenFOAM。</p></blockquote><h1 id="OpenFOAM的两个版本"><a href="#OpenFOAM的两个版本" class="headerlink" title="OpenFOAM的两个版本"></a>OpenFOAM的两个版本</h1><p>OpenFOAM有不少分支，其中最常用的有两个版本: <a href="https://www.openfoam.org/" target="_blank" rel="noopener">OpenFOAM基金会版</a>和<a href="https://www.openfoam.com/" target="_blank" rel="noopener">ESI集团版</a>。</p><ul><li>OpenFOAM基金会版用数字作版本号，名字像OpenFOAM-6，7，8，一年发布一次，网站是<a href="https://www.openfoam.org/" target="_blank" rel="noopener">https://www.openfoam.org</a>。</li><li>ESI集团版最近几年开始用字母v加年份和月份作版本号，比如OpenFAMv1912， v2006，半年发布一次，一般是在当年的6月和12月。网站是<a href="https://www.openfoam.com/" target="_blank" rel="noopener">https://www.openfoam.com</a>。</li></ul><p>这个是OpenFOAM的分支图，OpenFOAM基金会版和ESI集团版在2016年开始分家了，有兴趣的朋友可以看一下<a href="https://www.openfoam.com/history/" target="_blank" rel="noopener">OpenFOAM的发展史</a>。</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://upload.wikimedia.org/wikipedia/commons/1/18/Openfoam-history.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>相比它们的发展史，其实我们更关心的是这两个版本功能上差别大不大。总地来说，两者主体内容差别不大，代码风格和计算效率相近。但是最近的几个版本差别开始变大了，有时候同一套代码在一个上编译没问题但在同期的另一个版本却编译不通。ESI版本更新得更激进一些，会有一些OpenFOAM基金会版没有的求解器和算例。</p><h1 id="在Ubuntu上安装OpenFOAM"><a href="#在Ubuntu上安装OpenFOAM" class="headerlink" title="在Ubuntu上安装OpenFOAM"></a>在Ubuntu上安装OpenFOAM</h1><p>OpenFOAM最初是开发在Linux操作系统上的，在Linux上安装OpenFOAM也更方便一些。以<a href="https://ubuntu.com/" target="_blank" rel="noopener">Ubuntu</a>为例，讲一下OpenFOAM的两种安装方式。</p><h2 id="apt安装"><a href="#apt安装" class="headerlink" title="apt安装"></a><span id="apt">apt安装</span></h2><p><em>最快最方便，但需要联网，需要sudo权限</em></p><p>开机进入Ubuntu，快捷键<code>Ctrl+Alt+T</code>(或者依次点击 应用， 附件， 终端)启动终端，复制下面四行，按照提示输入密码然后确认安装。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo sh -c "wget -O - https://dl.openfoam.org/gpg.key | apt-key add -"</span><br><span class="line">sudo add-apt-repository http://dl.openfoam.org/ubuntu</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install openfoam8</span><br></pre></td></tr></table></figure><p>上面四行做的事情分别是添加软件包密钥，添加软件仓库地址，更新软件仓库，下载并安装openfoam-8。OpenFOAM会被安装在<code>/opt</code>目录下，默认<code>paraview</code>也会一并安装。</p><p>参考<a href="https://openfoam.org/download/8-ubuntu/" target="_blank" rel="noopener">https://openfoam.org/download/8-ubuntu/</a> 。</p><h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><p><em>大约需要30分钟到6个小时，可以不联网也不用sudo权限</em></p><p>同样，先开机进入Ubuntu，快捷键<code>Ctrl+Alt+T</code>(或者依次点击 应用， 附件， 终端)启动终端，依次复制粘贴下面的命令。</p><ul><li><p>创建OpenFOAM安装目录，建议装在<code>$HOME/OpenFOAM</code>下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir $HOME/OpenFOAM</span><br><span class="line">cd $HOME/OpenFOAM</span><br></pre></td></tr></table></figure></li><li><p>下载<a href="https://sourceforge.net/projects/openfoam/files/v2006/OpenFOAM-v2006.tgz" target="_blank" rel="noopener">OpenFOAM</a>和<a href="https://sourceforge.net/projects/openfoam/files/v2006/OpenFOAM-v2006.tgz" target="_blank" rel="noopener">ThirdParty</a>源码放在<code>$HOME/OpenFOAM</code>目录下。有网的话直接在终端输入下面两行下载。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -P $HOME/OpenFOAM https://sourceforge.net/projects/openfoam/files/v2006/OpenFOAM-v2006.tgz</span><br><span class="line">wget -P $HOME/OpenFOAM https://sourceforge.net/projects/openfoam/files/v2006/OpenFOAM-v2006.tgz</span><br></pre></td></tr></table></figure></li><li><p>解压到安装目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -xzf OpenFOAM-v2006.tgz -C $HOME/OpenFOAM </span><br><span class="line">tar -xzf ThirdParty-v2006.tgz -C $HOME/OpenFOAM</span><br></pre></td></tr></table></figure></li><li><p>索引<code>OpenFOAM</code>安装环境</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/OpenFOAM/OpenFOAM-v2006/etc/bashrc</span><br></pre></td></tr></table></figure></li><li><p>进入<code>$WM_PROJECT_DIR</code>目录并检查安装环境是否满足要求，<code>ubuntu</code>新系统是满足的，如果不满足则需要补充安装相应的库。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">foam</span><br><span class="line">foamSystemCheck</span><br></pre></td></tr></table></figure></li><li><p>接下来正式编译<code>OpenFOAM</code>，这个过程比较耗时，大约需要30分钟到6个小时</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./Allwmake -s -l -k -j</span><br></pre></td></tr></table></figure><p>这里解释一下<code>./Allwmake</code>后面的几个选项的含义，<code>-l</code>是自动记录log文件， <code>-s</code>是在编译过程中废话少说减少log文件大小，<code>-k</code>是跳过编译错误即使编译出错也继续编译完不要停，<code>-j</code>是并行编译可以减少编译时间，后面可以接数字指定编译核数，默认是用所有的核。</p></li><li><p>编译完以后我们再执行一遍<code>./Allwmake</code>，这一次去掉<code>-k</code>选项，查看编译过程是否出错（这一步操作非必须，可跳过）。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./Allwmake -s -l -j</span><br></pre></td></tr></table></figure><p>一切正常的话会有输出提示，告诉你编译已经完成，接下来测试OpenFOAM。</p></li><li><p>复制<code>cavity</code>算例到<code>$FOAM_RUN</code>目录，测试<code>blockMesh</code>网格工具和<code>icoFoam</code>求解器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">run</span><br><span class="line">cp -r $FOAM_TUTORIALS/incompressible/icoFoam/cavity/cavity $FOAM_RUN</span><br><span class="line">cd cavity</span><br><span class="line">blockMesh</span><br><span class="line">icoFoam</span><br></pre></td></tr></table></figure></li></ul><p>参考<a href="https://www.openfoam.com/download/install-source.php" target="_blank" rel="noopener">https://www.openfoam.com/download/install-source.php</a></p><h1 id="在Windows安装OpenFOAM"><a href="#在Windows安装OpenFOAM" class="headerlink" title="在Windows安装OpenFOAM"></a>在Windows安装OpenFOAM</h1><h2 id="WSL安装"><a href="#WSL安装" class="headerlink" title="WSL安装"></a>WSL安装</h2><p><em>仅适用于Windows 10</em>系统<br>windows 10 提供了适用于Linux子系统WSL (Windows Subsystem for Linux)，你可以在这上面安装Ubuntu子系统，然后参考上一节在Ubuntu上安装OpenFOAM的方法apt或者编译安装OpenFOAM。</p><ul><li><p>开启WSL<br>参考这个帖子<a href="https://zhuanlan.zhihu.com/p/34133795" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/34133795</a></p></li><li><p>在微软商店里中搜索<code>Ubuntu</code>，安装最新版(目前是<code>Ubuntu 20.04 LTS</code>)。</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://pic4.zhimg.com/80/v2-22f1b7d0d06f32a9d65d10dfd7e96f8f_720w.jpg" alt="" title="">                </div>                <div class="image-caption"></div>            </figure></li><li><p>装好后快捷<code>Win+R</code>打开系统自带的运行命令，输入<code>bash</code>回车就进入<code>Ubuntu</code>的终端了，接下来参考<a href="#apt">apt安装</a>。</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://pic3.zhimg.com/80/v2-a5abec39354e06a400f87d4367031ae4_720w.jpg" alt="" title="">                </div>                <div class="image-caption"></div>            </figure></li></ul><h2 id="虚拟机安装"><a href="#虚拟机安装" class="headerlink" title="虚拟机安装"></a>虚拟机安装</h2><p>如果你是windows 7或者windows XP系统，也可以选择安装<a href="https://my.vmware.com/cn/web/vmware/downloads/info/slug/desktop_end_user_computing/vmware_workstation_pro/15_0" target="_blank" rel="noopener">VMware虚拟机</a>，具体参考<a href="http://dyfluid.com/docs/install.html" target="_blank" rel="noopener">李东岳的教程</a>。他提供了VMware虚拟机文件，里面有Ubuntu系统和编译好的OpenFOAM，比较方便。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;OpenFOAM最近发布了最新的两个版本OpenFOAM-8和OpenFOAMv2006, 这篇博客简单介绍一下这两个版本的区别，然后讲一下如何在Ubuntu和Windows系统下安装这两个版本的OpenFOAM。&lt;/p&gt;
&lt;/blockquote
      
    
    </summary>
    
      <category term="OpenFOAM" scheme="http://zmengxu.github.io/categories/OpenFOAM/"/>
    
    
      <category term="course" scheme="http://zmengxu.github.io/tags/course/"/>
    
  </entry>
  
  <entry>
    <title>Git 的常用用法</title>
    <link href="http://zmengxu.github.io/2020/06/GitUsage/"/>
    <id>http://zmengxu.github.io/2020/06/GitUsage/</id>
    <published>2020-06-25T19:51:54.000Z</published>
    <updated>2020-11-01T21:20:52.077Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Git-and-Github-Usage"><a href="#Git-and-Github-Usage" class="headerlink" title="Git and Github Usage"></a><strong>Git and Github Usage</strong></h1><blockquote><p><a href="https://github.github.com/training-kit/downloads/github-git-cheat-sheet.pdf" target="_blank" rel="noopener">Git Cheat Sheet</a><br><a href="https://git-scm.com/docs" target="_blank" rel="noopener">Git Doc</a><br><a href="https://www.runoob.com/git/git-tutorial.html" target="_blank" rel="noopener">Git 教程</a></p></blockquote><h2 id="Git-and-Github"><a href="#Git-and-Github" class="headerlink" title="Git and Github"></a>Git and Github</h2><ol><li><a href="https://git-scm.com/docs" target="_blank" rel="noopener"><code>Git</code></a> is the open source distributed version control system that facilitates GitHub activities on your laptop or desktop.</li></ol><ul><li>It can be used to install update run uninstall package without <code>sudo</code> rights.</li><li>It can be used to create different environments for software version management. This is useful in switching different project.</li></ul><ol start="2"><li><code>Github</code> is a platform for hosting and collaborating on Git repositories.</li></ol><h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><h3 id="Anaconda-in-Linux"><a href="#Anaconda-in-Linux" class="headerlink" title="Anaconda in Linux"></a>Anaconda in Linux</h3><p>See <a href="https://git-scm.com/" target="_blank" rel="noopener">https://git-scm.com/</a></p><h3 id="An-example-for-the-git-installation-in-Linux"><a href="#An-example-for-the-git-installation-in-Linux" class="headerlink" title="An example for the git installation in Linux"></a>An example for the git installation in Linux</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libcurl4-gnutls-dev libexpat1-dev gettext \</span><br><span class="line">  libz-dev libssl-dev</span><br><span class="line">apt-get install git</span><br><span class="line">git --version</span><br></pre></td></tr></table></figure><h3 id="An-example-for-the-git-installation-using-conda"><a href="#An-example-for-the-git-installation-using-conda" class="headerlink" title="An example for the git installation using conda"></a>An example for the git installation using conda</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install -c anaconda git</span><br></pre></td></tr></table></figure><h2 id="How-to-use-conda"><a href="#How-to-use-conda" class="headerlink" title="How to use conda"></a>How to use conda</h2><h3 id="CONFIGURE-TOOLING"><a href="#CONFIGURE-TOOLING" class="headerlink" title="CONFIGURE TOOLING"></a>CONFIGURE TOOLING</h3><p>Sets the name you want atached to your commit transactions</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name "[name]"</span><br></pre></td></tr></table></figure><p>Sets the email you want atached to your commit transactions</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.email "[email address]"</span><br></pre></td></tr></table></figure><p>Enables helpful colorization of command line output</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global color.ui auto</span><br></pre></td></tr></table></figure><h3 id="CREATE-REPOSITORIES"><a href="#CREATE-REPOSITORIES" class="headerlink" title="CREATE REPOSITORIES"></a>CREATE REPOSITORIES</h3><p>Downloads a project and its entire version history from github</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone [url]</span><br></pre></td></tr></table></figure><p>Creates a new floder named [project-name]<br>and init it as a local repository </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git init [project-name]</span><br></pre></td></tr></table></figure><p>or init the current folder</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br></pre></td></tr></table></figure><h3 id="MAKE-CHANGES"><a href="#MAKE-CHANGES" class="headerlink" title="MAKE CHANGES"></a>MAKE CHANGES</h3><p>stage files (in the current folder) into the repository </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add [file]</span><br><span class="line">git add -A</span><br><span class="line">git add .</span><br></pre></td></tr></table></figure><p>Unstages the file, but preserve its contents<br>Like un-add one of the file</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset [file]</span><br></pre></td></tr></table></figure><p>Deletes the file from the working directory and stages the deletion<br>–cached is “Removes the file from version control but preserves the file locally”</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git rm [file]</span><br><span class="line">git rm --cached [file]</span><br></pre></td></tr></table></figure><p>Changes the file name and prepares it for commit</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git mv [file-original] [file-renamed]</span><br></pre></td></tr></table></figure><p>record the staged files permanently in version history<br>DO COMMITS</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit -m "[descriptive message]"</span><br></pre></td></tr></table></figure><p>REDO COMMITS<br>Erase mistakes and craf replacement history<br>Undoes all commits afer [commit], preserving changes locally</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset [commit]</span><br></pre></td></tr></table></figure><p>Discards all history and changes back to the specified commit</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard [commit]</span><br></pre></td></tr></table></figure><h3 id="REVIEW-HISTORY"><a href="#REVIEW-HISTORY" class="headerlink" title="REVIEW HISTORY"></a>REVIEW HISTORY</h3><p>Browse and inspect the evolution of project files</p><p>List all of the files in the current repository<br>A text file named .gitignore suppresses accidental versioning of<br>files and paths matching the specified paterns</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git ls-files</span><br><span class="line">git ls-files --other --ignored --exclude-standard</span><br></pre></td></tr></table></figure><p>Lists all new or modified files to be commited</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br></pre></td></tr></table></figure><p>Shows file differences not yet staged<br>It works only when you have add this file<br>but now you change it without adding again<br>exit the environment.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff</span><br></pre></td></tr></table></figure><p>If it is staged (git add), you can not see<br>the difference anymore. But you can use this<br>command to see the file differences between staging and the last file version</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff --staged</span><br></pre></td></tr></table></figure><p>Shows content differences between two branches</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff [first-branch]...[second-branch]</span><br></pre></td></tr></table></figure><p>Lists version history for the current branch<br>List the log in breaf<br>Lists version history for a file, including renames</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git log</span><br><span class="line">git log --oneline</span><br><span class="line">git log --follow [file]</span><br></pre></td></tr></table></figure><p>Outputs metadata and content changes of the specified commit</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git show [commit]</span><br></pre></td></tr></table></figure><h3 id="GROUP-CHANGES"><a href="#GROUP-CHANGES" class="headerlink" title="GROUP CHANGES"></a>GROUP CHANGES</h3><p>Name a series of commits and combine completed efforts<br>The master branch is created when you record (commit) the first change</p><p>Lists all local branches in the current repository</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch</span><br></pre></td></tr></table></figure><p>Jump to another branch, or creates a new branch and jump (if not exist) </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout [branch-name]</span><br><span class="line">git branch [branch-name]</span><br></pre></td></tr></table></figure><p>Combines the specified branch’s history into the current branch</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git merge [branch]</span><br><span class="line">git rebase [branch]</span><br></pre></td></tr></table></figure><p>Deletes the specified branch</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -d [branch-name]</span><br></pre></td></tr></table></figure><h3 id="SAVE-FRAGMENTS"><a href="#SAVE-FRAGMENTS" class="headerlink" title="SAVE FRAGMENTS"></a>SAVE FRAGMENTS</h3><p>Shelve and restore incomplete changes</p><p>Temporarily stores all modified tracked files</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git stash</span><br></pre></td></tr></table></figure><p>Restores the most recently stashed files</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git stash pop</span><br></pre></td></tr></table></figure><p>Lists all stashed changesets</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git stash list</span><br></pre></td></tr></table></figure><p>Discards the most recently stashed changeset</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git stash drop</span><br></pre></td></tr></table></figure><h3 id="SYNCHRONIZE-CHANGES"><a href="#SYNCHRONIZE-CHANGES" class="headerlink" title="SYNCHRONIZE CHANGES"></a>SYNCHRONIZE CHANGES</h3><p>Register a repository bookmark and exchange version history</p><p>Downloads all history from the repository bookmark</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git fetch [bookmark]</span><br></pre></td></tr></table></figure><p>Combines bookmark’s branch into current local branch</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge [bookmark]/[branch]</span><br></pre></td></tr></table></figure><p>Uploads all local branch commits to GitHub</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git push [alias] [branch]</span><br><span class="line">git push origin dev</span><br><span class="line">git push -u origin [branch]</span><br></pre></td></tr></table></figure><p>Uploads a specific branch (dev) to GitHub, if there is no dev branch in GitHub, a new branch will be created</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin dev</span><br></pre></td></tr></table></figure><p>Downloads bookmark history and incorporates changes</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull</span><br></pre></td></tr></table></figure><h2 id="Glossary"><a href="#Glossary" class="headerlink" title="Glossary"></a>Glossary</h2><p><code>git</code>: an open source, distributed version-control system<br><code>GitHub</code>: a platform for hosting and collaborating on Git repositories<br><code>commit</code>: a Git object, a snapshot of your entire repository compressed into a SHA<br><code>branch</code>: a lightweight movable pointer to a commit<br><code>clone</code>: a local version of a repository, including all commits and branches<br><code>remote</code>: a common repository on GitHub that all team member use to exchange their changes<br><code>fork</code>: a copy of a repository on GitHub owned by a different user<br><code>pull request</code>: a place to compare and discuss the differences introduced on a branch with reviews, comments, integrated tests, and more<br><code>HEAD</code>: representing your current working directory, the HEAD pointer can be moved to different branches, tags, or commits when using git checkout</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Git-and-Github-Usage&quot;&gt;&lt;a href=&quot;#Git-and-Github-Usage&quot; class=&quot;headerlink&quot; title=&quot;Git and Github Usage&quot;&gt;&lt;/a&gt;&lt;strong&gt;Git and Github Usa
      
    
    </summary>
    
      <category term="software" scheme="http://zmengxu.github.io/categories/software/"/>
    
    
      <category term="git" scheme="http://zmengxu.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>TecentOS tiny in STM32F4</title>
    <link href="http://zmengxu.github.io/2020/05/TecentOS-tiny-in-STM32F4/"/>
    <id>http://zmengxu.github.io/2020/05/TecentOS-tiny-in-STM32F4/</id>
    <published>2020-05-24T17:41:27.000Z</published>
    <updated>2020-11-01T21:20:52.077Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>2019 年腾讯开源了自己的物联网(internet of thing, IoT) 操作系统 <a href="https://github.com/Tencent/TencentOS-tiny" target="_blank" rel="noopener">TencentOS tiny</a>，我加入了他们的官方讨论群，关注了很久。最近疫情在家把<a href="https://github.com/Tencent/TencentOS-tiny" target="_blank" rel="noopener">TencentOS tiny</a>移植到了自己的一块STM32F407的开发板上，移植还算顺利，这里记录一下过程。</p></blockquote><h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>腾讯官方<a href="https://github.com/Tencent/TencentOS-tiny/blob/master/doc/10.Porting_Manual_for_KEIL.md" target="_blank" rel="noopener">移植指南</a>没有具体型号MCU的介绍，网上我只找到了这篇博客 <a href="https://juejin.im/post/5da7289d51882553690284a3" target="_blank" rel="noopener">https://juejin.im/post/5da7289d51882553690284a3</a> 介绍了STM32F103的MCU的移植。我自己的开发板STM32F407的，网上没有，有必要记录下来供参考。</p><h1 id="开发板介绍"><a href="#开发板介绍" class="headerlink" title="开发板介绍"></a>开发板介绍</h1><p>我用的是这个<a href="https://os.mbed.com/users/hudakz/code/STM32F407VET6_Hello//rev/1a172e2d6b86/" target="_blank" rel="noopener">STM32F407VET6 black board</a>开发板，ARM Cortex-M4 内核，相同内核的开发板都可以参考。</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="http://shijiexu.asuscomm.com:9000/api/file/getImage?fileId=5ec98432535d910013000009" alt="STM32F407VET6 black board" title="">                </div>                <div class="image-caption">STM32F407VET6 black board</div>            </figure><h1 id="具体步骤"><a href="#具体步骤" class="headerlink" title="具体步骤"></a>具体步骤</h1><hr><h2 id="创建keil下的裸机工程模板"><a href="#创建keil下的裸机工程模板" class="headerlink" title="创建keil下的裸机工程模板"></a><span id="jump">创建keil下的裸机工程模板</span></h2><p>先找到开发板的前后台系统工程模板，一般买开发板的时候学习资料里就有，也可以在我的github上下载，这是下载链接<a href="https://github.com/ZmengXu/STM32ProjectTemplate.git" target="_blank" rel="noopener">https://github.com/ZmengXu/STM32ProjectTemplate.git</a>。</p><p>用Keil软件(也可以在linux或者mac上写个Makefile文件通过arm-none-eabi-gcc来编译，后面我会写个这样的教程)打开工程模板中<code>USER/Template.uvprojx</code>文件, 我用的是Keil μVision5，打开后是这样的</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="http://shijiexu.asuscomm.com:9000/api/file/getImage?fileId=5eca938f535d91001300000d" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p><code>F7</code>编译工程文件，如果下载的是我GitHub上提供的文件，编译是可以直接通过的，并且会自动新建一个<code>OBJ</code>文件夹，并在该文件夹下生成<code>Template.hex</code>的16进制文件。</p><p>接下来将<code>Template.hex</code>文件写入<code>STM32F407</code>开发板。我用的是ST-LINK V2 采用SW方式连接开发板，打开魔法棒<code>Options for Target</code>按钮，选<code>Debug</code>， 右侧<code>Use</code>选项打开下拉菜单选<code>ST-Link Debugger</code>，然后点击<code>setting</code>，修改<code>ort</code>选项为<code>SW</code>，连接好开发板插入<code>ST-LINK</code>，这时候右侧<code>SW Device</code>就可以看到电脑找到了刚刚插入的设备。</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="http://shijiexu.asuscomm.com:9000/api/file/getImage?fileId=5eca938f535d910013000011" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>回到桌面，点击<code>Download</code>，刚刚的16进制文件<code>Template.hex</code>就被写入开发板了。连接上串口，打开串口调试助手，按一下开发板上的复位，调试助手就可以收到这样的输入信息了。</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="http://shijiexu.asuscomm.com:9000/api/file/getImage?fileId=5eca938f535d91001300000e" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><h2 id="创建新的工程并移植TencentOS-tiny"><a href="#创建新的工程并移植TencentOS-tiny" class="headerlink" title="创建新的工程并移植TencentOS tiny"></a>创建新的工程并移植TencentOS tiny</h2><h3 id="下载TencentOS-tiny的源码"><a href="#下载TencentOS-tiny的源码" class="headerlink" title="下载TencentOS tiny的源码"></a>下载TencentOS tiny的源码</h3><p>去GitHub上<a href="https://github.com/Tencent/TencentOS-tiny" target="_blank" rel="noopener">https://github.com/Tencent/TencentOS-tiny</a>或者去腾讯工蜂开源仓<a href="https://git.code.tencent.com/Tencent_Open_Source/TencentOS-tiny" target="_blank" rel="noopener">https://git.code.tencent.com/Tencent_Open_Source/TencentOS-tiny</a>下载。我是在GitHub上下的，参考<a href="https://juejin.im/post/5da7289d51882553690284a3" target="_blank" rel="noopener">杰杰</a>的建议后者会快些。</p><p>下载下来后有很多子目录，但我们只需要下面几个目录。</p><table><thead><tr><th>一级目录</th><th align="right">二级目录</th><th align="center">说明</th></tr></thead><tbody><tr><td>arch</td><td align="right">arm/arm-v7m</td><td align="center">TencentOS tiny适配的IP核架构（含M核中断、调度、tick相关代码）</td></tr><tr><td>board</td><td align="right">STM32F407VGT6_discovery/TOS_CONFIG</td><td align="center">移植目标芯片的工程文件的配置文件，根据情况选一个最接近自己开发板的</td></tr><tr><td>kernel</td><td align="right">core</td><td align="center">TencentOS tiny内核源码</td></tr><tr><td></td><td align="right">pm</td><td align="center">tiny低功耗模块源码，本次移植暂不使用</td></tr><tr><td>osal</td><td align="right">cmsis_os</td><td align="center">TencentOS tiny提供的cmsis os 适配</td></tr></tbody></table><h3 id="修改工程文件"><a href="#修改工程文件" class="headerlink" title="修改工程文件"></a>修改工程文件</h3><p>复制一个模板工程目录，重命名为<code>Demo_MultiTask</code>，在该目录下新建一个文件夹，<code>TencentOS</code>，然后把<code>arm-v7m</code>，<code>core</code>和<code>cmsis_os</code>目录复制到<code>TencentOS</code>中。</p><p>创建一个<code>TOS_CONFIG</code>子文件夹，并创建一个<code>tos_config.h</code>文件，下面是我用到的，附有腾讯官方解释</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _TOS_CONFIG_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  _TOS_CONFIG_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stm32f4xx.h"</span><span class="comment">// 目标芯片头文件，用户需要根据情况更改</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_TASK_PRIO_MAX           10u <span class="comment">// 配置TencentOS tiny默认支持的最大优先级数量</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_ROUND_ROBIN_EN          0u<span class="comment">// 配置TencentOS tiny的内核是否开启时间片轮转</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_OBJECT_VERIFY_EN           1u<span class="comment">// 配置TencentOS tiny是否校验指针合法</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_TASK_DYNAMIC_CREATE_EN  1u<span class="comment">// TencentOS tiny 动态任务创建功能宏</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_EVENT_EN                1u<span class="comment">// TencentOS tiny 事件模块功能宏</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_MMBLK_EN                1u<span class="comment">//配置TencentOS tiny是否开启内存块管理模块</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_MMHEAP_EN               1u<span class="comment">//配置TencentOS tiny是否开启动态内存模块</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_MMHEAP_DEFAULT_POOL_EN  1u<span class="comment">// TencentOS tiny 默认动态内存池功能宏</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_MMHEAP_DEFAULT_POOL_SIZE        0x100<span class="comment">// 配置TencentOS tiny默认动态内存池大小</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_MUTEX_EN                1u<span class="comment">// 配置TencentOS tiny是否开启互斥锁模块</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_MESSAGE_QUEUE_EN        1u<span class="comment">// 配置TencentOS tiny是否开启消息队列模块</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_MAIL_QUEUE_EN           1u<span class="comment">// 配置TencentOS tiny是否开启消息邮箱模块</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_PRIORITY_MESSAGE_QUEUE_EN1u<span class="comment">// 配置TencentOS tiny是否开启优先级消息队列模块</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_PRIORITY_MAIL_QUEUE_EN1u<span class="comment">// 配置TencentOS tiny是否开启优先级消息邮箱模块</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_TIMER_EN                1u<span class="comment">// 配置TencentOS tiny是否开启软件定时器模块</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_PWR_MGR_EN              0u<span class="comment">// 配置TencentOS tiny是否开启外设电源管理模块</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_TICKLESS_EN             0u<span class="comment">// 配置Tickless 低功耗模块开关</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_SEM_EN                  1u<span class="comment">// 配置TencentOS tiny是否开启信号量模块</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_TASK_STACK_DRAUGHT_DEPTH_DETACT_EN      1u<span class="comment">// 配置TencentOS tiny是否开启任务栈深度检测</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_FAULT_BACKTRACE_EN      0u<span class="comment">// 配置TencentOS tiny是否开启异常栈回溯功能</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_IDLE_TASK_STK_SIZE      1512<span class="comment">// 配置TencentOS tiny空闲任务栈大小</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_CPU_TICK_PER_SECOND     1000u<span class="comment">// 配置TencentOS tiny的tick频率</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_CPU_CLOCK               (SystemCoreClock)<span class="comment">// 配置TencentOS tiny CPU频率</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOS_CFG_TIMER_AS_PROC           1u<span class="comment">// 配置是否将TIMER配置成函数模式</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure><h3 id="添加-c和-s文件到工程中"><a href="#添加-c和-s文件到工程中" class="headerlink" title="添加.c和.s文件到工程中"></a>添加.c和.s文件到工程中</h3><p>打开<code>USER/Template.uvprojx</code>文件，依次添加arch平台代码和内核源码。具体地</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="http://shijiexu.asuscomm.com:9000/api/file/getImage?fileId=5eca938f535d91001300000f" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>点击<code>File Extensions</code>新建工程分组<code>tos/arch</code>。点击右侧的<code>Add Files</code>添加<code>TencentOS\arm-v7m\cortex-m4\common</code>里的<code>tos_cpu.c</code>文件和<code>TencentOS\arm-v7m\cortex-m4\armcc</code>里的<code>port_c.c</code>和<code>port_c.S</code>。同样新建工程分组和<code>tos/kernel</code>。添加<code>TencentOS\kernel\core</code>里的所有<code>.c</code>文件。另外，pm是内核中的低功耗组件，基础移植的时候可以不添加。</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="http://shijiexu.asuscomm.com:9000/api/file/getImage?fileId=5eca938f535d91001300000b" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><h3 id="添加TencentOS-tiny头文件目录"><a href="#添加TencentOS-tiny头文件目录" class="headerlink" title="添加TencentOS tiny头文件目录"></a>添加TencentOS tiny头文件目录</h3><p>打开魔法棒<code>Options for Target</code>按钮，选<code>C/C++</code>， 右侧<code>Use</code>选项打开下拉菜<br>点击添加的头文件目录如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">..\TencentOS\arm-v7m\common\include</span><br><span class="line">..\TencentOS\arm-v7m\cortex-m4\armcc</span><br><span class="line">..\TencentOS\core\include</span><br><span class="line">..\TencentOS\cmsis_os</span><br><span class="line">..\TencentOS\TOS-CONFIG</span><br></pre></td></tr></table></figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="http://shijiexu.asuscomm.com:9000/api/file/getImage?fileId=5eca938f535d910013000012" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>//在<code>C/C++</code>界面上一定要勾上c99，否则编译的时候出underfined reference 的错误（好像不是这个原因，是我忘了添加<code>tos_cpu.c</code>文件了，不需要）</p><h3 id="修改部分代码"><a href="#修改部分代码" class="headerlink" title="修改部分代码"></a>修改部分代码</h3><p>修改SYSTEM/USART/usart.c第29行，_sys_exit(int x) 改为 void _sys_exit(int x)</p><p>修改stm32f4xx_it.c</p><ol><li>包含<code>#include &quot;tos_k.h&quot;</code> 头文件</li><li>注释掉<code>PendSV_Handler</code>函数</li><li>在<code>SysTick_Handler</code>函数中添加TencentOS tiny的调度处理函数<br>修改后<code>stm32f4xx_it.c</code>长这样<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;stm32f4xx_it.h&quot;</span><br><span class="line">#include &quot;tos_k.h&quot;</span><br><span class="line">...</span><br><span class="line">&#x2F;**</span><br><span class="line">  * @brief  This function handles PendSVC exception.</span><br><span class="line">  * @param  None</span><br><span class="line">  * @retval None</span><br><span class="line">  *&#x2F;</span><br><span class="line">&#x2F;&#x2F;void PendSV_Handler(void)</span><br><span class="line">&#x2F;&#x2F;&#123;</span><br><span class="line">&#x2F;&#x2F;&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line">  * @brief  This function handles SysTick Handler.</span><br><span class="line">  * @param  None</span><br><span class="line">  * @retval None</span><br><span class="line">  *&#x2F;</span><br><span class="line">void SysTick_Handler(void)</span><br><span class="line">&#123;</span><br><span class="line">  if (tos_knl_is_running())</span><br><span class="line">  &#123;</span><br><span class="line">    tos_knl_irq_enter();</span><br><span class="line">    tos_tick_handler();</span><br><span class="line">    tos_knl_irq_leave();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li></ol><h3 id="编写main-c"><a href="#编写main-c" class="headerlink" title="编写main.c"></a>编写main.c</h3><p>这里参考官方测试代码，原链接在这里 <a href="https://github.com/Tencent/TencentOS-tiny/blob/master/doc/10.Porting_Manual_for_KEIL.md" target="_blank" rel="noopener">https://github.com/Tencent/TencentOS-tiny/blob/master/doc/10.Porting_Manual_for_KEIL.md</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;sys.h&quot;</span><br><span class="line">#include &quot;delay.h&quot;</span><br><span class="line">#include &quot;usart.h&quot;</span><br><span class="line"></span><br><span class="line">#include &quot;tos_k.h&quot;</span><br><span class="line">#include &quot;cmsis_os.h&quot;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;task1</span><br><span class="line">#define TASK1_STK_SIZE256</span><br><span class="line">void task1(void *pdata);</span><br><span class="line">osThreadDef(task1, osPriorityNormal, 1, TASK1_STK_SIZE);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;task2</span><br><span class="line">#define TASK2_STK_SIZE256</span><br><span class="line">void task2(void *pdata);</span><br><span class="line">osThreadDef(task2, osPriorityNormal, 1, TASK2_STK_SIZE);</span><br><span class="line"></span><br><span class="line">void task1(void *pdata)</span><br><span class="line">&#123;</span><br><span class="line"> int count &#x3D; 1;</span><br><span class="line"> while(1)</span><br><span class="line"> &#123;</span><br><span class="line"> printf(&quot;\r\nHello world!\r\n###This is task1 ,count is %d \r\n&quot;, count++);</span><br><span class="line"> osDelay(2000);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">void task2(void *pdata)</span><br><span class="line">&#123;</span><br><span class="line"> int count &#x3D; 1;</span><br><span class="line"> while(1)</span><br><span class="line"> &#123;</span><br><span class="line"> printf(&quot;\r\nHello TencentOS !\r\n***This is task2 ,count is %d \r\n&quot;, count++);</span><br><span class="line"> osDelay(1000);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line">uart_init(115200);&#x2F;&#x2F;bps 115200</span><br><span class="line">printf(&quot;Welcome to TencentOS tiny\r\n&quot;);</span><br><span class="line"></span><br><span class="line">osKernelInitialize(); &#x2F;&#x2F;TOS Tiny kernel initialize</span><br><span class="line">osThreadCreate(osThread(task1), NULL);&#x2F;&#x2F; Create task1</span><br><span class="line">osThreadCreate(osThread(task2), NULL);&#x2F;&#x2F; Create task2</span><br><span class="line">osKernelStart();&#x2F;&#x2F;Start TOS Tiny</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="编译并测试"><a href="#编译并测试" class="headerlink" title="编译并测试"></a>编译并测试</h2><p>编译和下载与模板例子<a href="#jump">模板例子</a>一样，<code>F7</code>编译工程文件，没有错误的话连接ST-LINK V2和开发板，点击Download下载程序到开发板。</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="http://shijiexu.asuscomm.com:9000/api/file/getImage?fileId=5eca938f535d910013000010" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>找一个USB转串口连接上电脑和开发板的UART1端口，记得TX-RX，RX-TX交替连接。打开串口调试助手，选择波特率115200，然后复位开发板，就可以收到上面的信息了。task1和task2交替打印，就说明TencentOS-tiny的任务调度功能实现了，移植成功。</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="http://shijiexu.asuscomm.com:9000/api/file/getImage?fileId=5eca938f535d91001300000c" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><h1 id="下载链接"><a href="#下载链接" class="headerlink" title="下载链接"></a>下载链接</h1><p>我放在github上了<a href="https://github.com/ZmengXu/STM32ProjectTemplate.git" target="_blank" rel="noopener">https://github.com/ZmengXu/STM32ProjectTemplate.git</a>。如果访问不了，可以发<a href="http://mailto:shijiexu2010@gmail.com/" target="_blank" rel="noopener">邮件</a>找我要。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;2019 年腾讯开源了自己的物联网(internet of thing, IoT) 操作系统 &lt;a href=&quot;https://github.com/Tencent/TencentOS-tiny&quot; target=&quot;_blank&quot; rel=&quot;noop
      
    
    </summary>
    
      <category term="IoT" scheme="http://zmengxu.github.io/categories/IoT/"/>
    
      <category term="STM32" scheme="http://zmengxu.github.io/categories/IoT/STM32/"/>
    
    
      <category term="TecentOS tiny" scheme="http://zmengxu.github.io/tags/TecentOS-tiny/"/>
    
  </entry>
  
  <entry>
    <title>SpanwiseAverage</title>
    <link href="http://zmengxu.github.io/2019/04/SpanwiseAverage/"/>
    <id>http://zmengxu.github.io/2019/04/SpanwiseAverage/</id>
    <published>2019-04-19T18:59:31.000Z</published>
    <updated>2020-11-01T21:20:52.077Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>很久之前就把网站搭建好了，但一直没往里写东西。最近被一位神秘的大佬催更，写篇文章吧。<br>无意中看到了一个之前写的后处理工具，决定就拿这个作第一篇博客。</p></blockquote><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>OpenFOAM不能对计算结果进行周向平均处理。所以就写了个后处理程序，用于对轴向对称流场的三维结果进行周向平均。</p><h2 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h2><p>确定一个周向平均操作需要给定两个量，基点basePoint和旋转向量spanwiseVector。接下来可以通过两种方法实现周向平均过程。</p><ul><li><p>对流场的所有网格遍历，将所有位于同一圆周线上的点加和求平均。可以这么实现：对原始坐标系进行坐标变换，将原来的三维坐标(x,y,z)映射到原点为basePoint高度方向为spanwiseVector的圆柱坐标系（r,z,theta）中；然后在theta方向上求平均，即将所有具有相同（r,z）的节点上的物理量取平均。</p></li><li><p>取有限个经过基点basePoint和旋转向量spanwiseVector的截面，将各截面上的物理量值求平均。这么实现：过基点和旋转向量选取任意一个截面，提取截面上各点的物理量值；将该初始截面旋转一个角度dTheta，对旋转后的新的截面也提取一次。如此，旋转一周均匀截取n个截面。最终对这n个截面上的物理量值取平均，得到周向平均的结果。</p></li></ul><p>显然，当截面数n比较小的情况下，方案二的计算量显著小于方案一；和理论值之间的偏差取决于截面数量，精度可控。所以接下来就按照方案二的思路来介绍，代码是基础OpenFOAM-4.1写的。</p><h2 id="具体步骤"><a href="#具体步骤" class="headerlink" title="具体步骤"></a>具体步骤</h2><ol><li>首先需要确定一个初始截面，提取截面上的坐标，在圆柱坐标系中记为（r,z,0）；</li><li>将初始截面上的每个点绕基点和旋转向量旋转角度dTheta，得到一个旋转后的采样点的坐标（r,z,theta）；</li><li>通过插值的方法得到旋转后的采样点上的物理量值。</li><li>重复步骤2-3，依次获取n个采样点的物理量值，取平均得到初始截面上任意一点（r,z,0）的周向平均值。</li></ol><hr><p>实现方法上参考了这篇<a href="https://www.cfd-online.com/Forums/openfoam-solving/58459-homogeneous-average.html" target="_blank" rel="noopener">cfd-online</a>帖子。</p><h3 id="1-确定初始截面"><a href="#1-确定初始截面" class="headerlink" title="1. 确定初始截面"></a>1. 确定初始截面</h3><p>值得一提的是，周向平均并不是一个普适性的后处理过程，它对计算域的几何形状有要求。有些几何形状并不是轴向对称，或者不是关于用户提供的基点basePoint和旋转向量normVector轴向对称的，从原理上讲本就无法进行周向平均。那么这样的几何形状怎么处理，这里涉及到一个容错的问题，这在后面会提到，这应该也是为什么OpenFOAM官方没有提供周向平均后处理程序的一个原因。</p><p>本着尽可能用OpenFOAM现有类和函数的原则，我们找到了cuttingPlane类和sampledSurface类，前者可以根据基点basePoint和法向量normVector截取一个初始截面并获得在该截面上的点的坐标，后者则是用来获取这些点的物理量值的。显然，我们直接继承这两个类就可以完成步骤1的主要内容了，而OpenFOAM恰好有一个很好的例子，就是sampledPlan类，同时继承了上面提到的两个类，它在这里</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$FOAM_SRC&#x2F;sampling&#x2F;sampledSurface&#x2F;sampledPlan</span><br></pre></td></tr></table></figure><p>所以我们就按照sampledPlan类改写，新建一个新的类sampledPlaneSpanwise，这里截取一段类的声明，新增了采样点个数nPoints_和旋转向量spanwiseVector_. 基点basePoint和初始截面的法向量normVector就不需要了，因为他们可以直接从cuttingPlane类继承来。</p><p>sampledPlaneSpanwise/sampledPlaneSpanwise.H</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class sampledPlaneSpanwise</span><br><span class="line">:</span><br><span class="line">    public sampledSurface,</span><br><span class="line">    public cuttingPlane</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; Private data</span><br><span class="line">        &#x2F;&#x2F;- Direction normal to the plane</span><br><span class="line">            word axis_;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;- Number of points used to compute the average</span><br><span class="line">            label nPoints_;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;- Number of points used to compute the average</span><br><span class="line">            vector spanwiseVector_;</span><br></pre></td></tr></table></figure><p>在sampledPlaneSpanwise类的构造函数中，有这么一段，用于判断初始截面的法向量normVector和旋转向量spanwiseVector是否垂直，这是容错机制的一部分。</p><p>sampledPlaneSpanwise/sampledPlaneSpanwise.C</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const vector&amp; normal &#x3D; spanwiseVector_;</span><br><span class="line">const vector&amp; planNorm &#x3D; this-&gt;normal();</span><br><span class="line">if ( mag(normal&amp;planNorm) &gt; SMALL)</span><br><span class="line">&#123;</span><br><span class="line">    FatalErrorIn</span><br><span class="line">        (</span><br><span class="line">             &quot;Foam::sampledAveragePlane::sampledAveragePlane&quot;</span><br><span class="line">        )   &lt;&lt; &quot;The spanwiseVector normal is not perpendicular to the plane normal&quot;</span><br><span class="line">            &lt;&lt; exit(FatalError);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-旋转采样"><a href="#2-旋转采样" class="headerlink" title="2. 旋转采样"></a>2. 旋转采样</h3><p>圆周采样类circleSet，可以给定圆心，半径和旋转轴在圆周方向上均匀采样，得到一组采样点的坐标。这么一来，圆柱坐标变换和旋转坐标变换的步骤也省了，所以说还是用OpenFOAM现有类和函数好啊。</p><p>circleSet类的声明和定义在这里：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$FOAM_SRC&#x2F;sampling&#x2F;sampledSet&#x2F;circle</span><br></pre></td></tr></table></figure><p>所以，旋转采样就可以这么实现：为每个初始截面上的点currentPoint，创建一个circleSet对象，其中包含nPoints_个采样点，相邻两个采样点之间的夹角是dTheta。</p><p>sampledPlaneSpanwise/sampledPlaneSpanwiseTemplates.C</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Extract the circle in the homogeneous direction</span><br><span class="line">    circleSet   line(&quot;circleLine&quot;, mesh(), searchEngine, axis_, circleOrigin, normalVector, currentPoint, dTheta);</span><br></pre></td></tr></table></figure><p>circleSet在创建新对象时会调用findCell函数查找改采样点是否在计算域内，不在的话会有输出警告。这也是前面提到的容错机制的一种，只有选取了合适的基点basePoint法向量normVector和旋转向量spanwiseVector才能保证所有的采样点都在计算域内。</p><h3 id="3-插值获取采样点上的物理量"><a href="#3-插值获取采样点上的物理量" class="headerlink" title="3. 插值获取采样点上的物理量"></a>3. 插值获取采样点上的物理量</h3><p>参考 $FOAM_SRC/sampling/sampledSurface/sampledPlan/sampledPlanTemplates.C 当中的实现方法，调用interpolate函数，就可以得到圆周采样点上的物理量值。实现如下</p><p>sampledPlaneSpanwise/sampledPlaneSpanwiseTemplates.C</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">forAll(line, lineI)</span><br><span class="line">&#123;</span><br><span class="line">        linevalues[lineI] &#x3D; interpolator.interpolate</span><br><span class="line">        (</span><br><span class="line">                line[lineI],</span><br><span class="line">                line.cells()[lineI],</span><br><span class="line">                line.faces()[lineI]</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-取周向平均"><a href="#2-取周向平均" class="headerlink" title="2. 取周向平均"></a>2. 取周向平均</h3><p>得到圆周采样点上的物理量值后，对nPoints_个点求平均即可得到改点处的周向平均值。对初始截面上每个点在每个物理量场(p, U, T …)上作相同地采样和平均处理，即可得到初始截面上的所有点的周向平均值，输出即可。而输出的格式因为继承了sampling类，既可以导出vtk格式又可以得到行列式的raw格式。具体参考sampledPlan的使用方法一样。文末提供的下载链接中也提供了一个算例作参考。</p><h2 id="下载链接"><a href="#下载链接" class="headerlink" title="下载链接"></a>下载链接</h2><p>我放在github上了<a href="https://github.com/ZmengXu/sampledAveragePlane" target="_blank" rel="noopener">https://github.com/ZmengXu/sampledAveragePlane</a>。如果访问不了，可以发邮件找我要。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;很久之前就把网站搭建好了，但一直没往里写东西。最近被一位神秘的大佬催更，写篇文章吧。&lt;br&gt;无意中看到了一个之前写的后处理工具，决定就拿这个作第一篇博客。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;需求&quot;&gt;&lt;a href=&quot;#需求&quot; cl
      
    
    </summary>
    
      <category term="OpenFOAM" scheme="http://zmengxu.github.io/categories/OpenFOAM/"/>
    
      <category term="utility" scheme="http://zmengxu.github.io/categories/OpenFOAM/utility/"/>
    
    
      <category term="postProcess" scheme="http://zmengxu.github.io/tags/postProcess/"/>
    
  </entry>
  
</feed>
